{% comment %}
  Renders the main product section based on index.html design
{% endcomment %}

{{ 'section-main-product.css' | asset_url | stylesheet_tag }}

<style>
  /* Fonts Gotham - Définitions manquantes */
  @font-face {
    font-family: 'Gotham';
    src: url('../fonts/gothambook-webfont.woff') format('woff');
    font-weight: 400;
    font-style: normal;
    font-display: swap;
  }

  @font-face {
    font-family: 'Gotham';
    src: url('../fonts/gothammedium-webfont.woff') format('woff');
    font-weight: 500;
    font-style: normal;
    font-display: swap;
  }

  @font-face {
    font-family: 'Gotham';
    src: url('../fonts/gothambold-webfont.woff') format('woff');
    font-weight: 700;
    font-style: normal;
    font-display: swap;
  }

  .font-gotham {
    font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
</style>

<span class="font-gotham font-bold w-full text-center my-10 block"
  >----------------Début de la section main-product----------------</span
>
<main class="font-gotham container mx-auto py-4">
  <div class="flex flex-col md:flex-row gap-8">
    <div class="basis-full md:basis-1/2">
      <!-- Gallery Section -->
      <section class="mb-6">
        <!-- Mobile Slider -->
        <div class="block md:hidden">
          <div class="overflow-hidden h-80">
            <div class="flex transition-transform duration-300 ease-in-out" id="slider">
              {% assign images = product.media | where: 'media_type', 'image' %}
              {% if images.size > 0 %}
                {% for media in images limit: 5 %}
                  <div class="relative">
                    {% if forloop.first and section.settings.badge_text %}
                      <span class="bg-sage-light absolute top-5 left-5 text-dark text-xs font-medium rounded-full px-4 py-2 z-10">
                        {{ section.settings.badge_text }}
                      </span>
                    {% endif %}
                    <img
                      src="{{ media | image_url: width: 800, height: 800 }}"
                      alt="{{ media.alt | default: 'Produit vue' }}"
                      class="w-4/5 h-80 object-cover shrink-0"
                      style="min-width: 100vw;"
                      width="800"
                      height="800"
                    >
                  </div>
                {% endfor %}
              {% else %}
                <!-- Fallback images si pas d'images produit -->
                {% for i in (1..5) %}
                  <div class="relative">
                    {% if forloop.first and section.settings.badge_text %}
                      <span class="bg-sage-light absolute top-5 left-5 text-dark text-xs font-medium rounded-full px-4 py-2 z-10">
                        {{ section.settings.badge_text }}
                      </span>
                    {% endif %}
                    <img
                      src="{{ i | append: '.jpg' | asset_url }}"
                      alt="Produit vue {{ i }}"
                      class="w-4/5 h-80 object-cover shrink-0"
                      style="min-width: 100vw;"
                      width="800"
                      height="800"
                    >
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
          <!-- Progress bar -->
          <div class="mt-4 px-4">
            <div
              class="slider-progress-bar relative h-1 cursor-pointer rounded-full bg-gray-300"
              onclick="clickProgressBar(event)"
            >
              <span
                class="slider-progress-indicator absolute h-full rounded-full bg-black transition-all duration-300 ease-in-out"
                style="left: 0%; width: 20%;"
              ></span>
            </div>
          </div>
        </div>

        <!-- Desktop Gallery -->
        <div class="hidden md:block">
          {% assign images = product.media | where: 'media_type', 'image' %}
          {% assign featured_image = images.first %}
          {% if images.size > 0 %}
            <div class="mb-4 relative">
              <span class="bg-sage-light absolute top-5 left-5 text-dark text-xs font-medium rounded-full px-4 py-2 z-10">
                {{ section.settings.badge_text | default: 'Hautement dosé' }}
              </span>
              <img
                src="{{ featured_image | image_url: width: 1200, height: 1200 }}"
                alt="{{ featured_image.alt }}"
                class="w-full aspect-square object-cover rounded-4xl"
                width="1200"
                height="1200"
              >
            </div>

            {% if images.size > 1 %}
              <div class="grid grid-cols-2 gap-2">
                {% for media in images offset: 1 limit: 4 %}
                  <img
                    src="{{ media | image_url: width: 600, height: 600 }}"
                    alt="{{ media.alt }}"
                    class="w-full aspect-square object-cover rounded-4xl"
                    width="600"
                    height="600"
                  >
                {% endfor %}
              </div>
            {% endif %}
          {% else %}
            <!-- Fallback images si pas d'images produit -->
            <div class="mb-4 relative">
              <span class="bg-sage-light absolute top-5 left-5 text-dark text-xs font-medium rounded-full px-4 py-2 z-10">
                {{ section.settings.badge_text | default: 'Hautement dosé' }}
              </span>
              <img
                src="{{ '1.jpg' | asset_url }}"
                alt="Produit vue principale"
                class="w-full aspect-square object-cover rounded-4xl"
                width="1200"
                height="1200"
              >
            </div>
            <div class="grid grid-cols-2 gap-2">
              {% for i in (2..5) %}
                <img
                  src="{{ i | append: '.jpg' | asset_url }}"
                  alt="Produit vue {{ i }}"
                  class="w-full aspect-square object-cover rounded-4xl"
                  width="600"
                  height="600"
                >
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <div class="basis-full md:basis-1/2">
      <!-- Reviews & Product Header -->
      <section class="mb-5 px-4">
        <div class="mb-5">
          <div class="flex items-center gap-2 font-bold text-sm">
            Excellent
            <img
              src="{{ 'trustpilot-etoile.png' | asset_url }}"
              alt="5 étoiles Trustpilot"
              class="h-4 w-auto"
              width="auto"
              height="16"
            >
            17.102 avis
            <img
              src="{{ 'trustpilot-logo.png' | asset_url }}"
              alt="Logo Trustpilot"
              class="h-4 w-auto"
              width="auto"
              height="16"
            >
          </div>
        </div>
        <div class="flex items-end justify-between">
          <h1 class="text-product-title font-bold font-gotham">{{ product.title }}</h1>
          {% assign current_variant = product.selected_or_first_available_variant %}
          <span class="text-product-price font-bold" id="main-price">
            {{- current_variant.price | money -}}
          </span>
        </div>
      </section>

      <!-- Product Description -->
      <section class="mb-9 px-4">
        <div class="mb-4 leading-relaxed text-sm">
          {{ product.description }}
        </div>
      </section>

      <!-- Pricing Options -->
      {% if product.variants.size >= 2 %}
        <section class="mb-8 px-4">
          <div class="flex gap-4">
            {% for variant in product.variants limit: 2 %}
              <div
                class="relative flex flex-1 flex-col gap-2 rounded-2xl {% if variant.id == current_variant.id %}bg-teal-light{% else %}border border-gray-light cursor-pointer hover:bg-gray-50{% endif %} px-3 pb-4 pt-5"
                onclick="changeVariant({{ variant.id }})"
                data-variant-id="{{ variant.id }}"
                data-variant-price="{{ variant.price | money }}"
              >
                <span class="absolute left-1/2 top-0 font-medium -translate-x-1/2 -translate-y-1/2 whitespace-nowrap rounded-full {% if variant.id == current_variant.id %}bg-sage-medium{% else %}bg-gray-light{% endif %} px-3 py-1 text-sm">
                  {% if forloop.first %}Découverte{% else %}Meilleur offre{% endif %}
                </span>
                <span class="text-center text-xl font-bold">{{ variant.title }}</span>
                <span class="text-center font-normal text-base text-gray-medium">
                  {% assign days_supply = 30 %}
                  {% assign daily_price = variant.price | divided_by: days_supply | divided_by: 100.0 | round: 2 %}
                  Soit {{ daily_price }}€ / jour
                </span>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      <!-- Purchase Section -->
      <section class="px-4 mb-12">
        {% form 'product', product %}
          <input type="hidden" name="id" value="{{ current_variant.id }}" id="product-variant-id">
          <div class="space-y-4">
            <button
              type="submit"
              class="w-full rounded-full bg-black px-9 py-7 text-xl font-bold text-white cursor-pointer"
            >
              Ajouter au panier |
              <span id="cart-price">
                {%- if current_variant.price %}{{ current_variant.price | money }}{% else %}35€{% endif -%}
              </span>
            </button>
            <p class="text-center text-sm font-normal text-dark">
              {% if current_variant.available %}
                <strong>En stock,</strong> commandez et soyez
                <strong>livré le {{ 'now' | date: '%s' | plus: 604800 | date: '%d %B' }}</strong>
              {% else %}
                <strong>Rupture de stock</strong> - Disponible sous
                {{ 'now' | date: '%s' | plus: 1209600 | date: '%d %B' }}
              {% endif %}
            </p>
          </div>
        {% endform %}
      </section>

      <!-- Accordion Section -->
      <section class="px-4">
        <div class="space-y-0">
          <!-- Bienfaits et efficacité -->
          <div class="accordion-item border-b border-t border-gray-200 py-5">
            <button
              class="accordion-toggle flex w-full items-center justify-between text-left text-base focus:outline-none cursor-pointer"
              onclick="toggleAccordion(this)"
            >
              <span>Bienfaits et efficacité</span>
              <img
                src="{{ 'Dropdown arrow.svg' | asset_url }}"
                alt=""
                class="accordion-arrow h-4 w-4 transform transition-transform duration-200"
                aria-hidden="true"
                width="16"
                height="16"
              >
            </button>
            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
              <div class="pt-4">
                <div class="font-normal text-dark text-sm">
                  {{
                    section.settings.benefits_content
                    | default: 'Les bienfaits de ce produit seront bientôt disponibles.'
                  }}
                </div>
              </div>
            </div>
          </div>

          <!-- Ingrédients -->
          <div class="accordion-item border-b border-gray-200 py-5">
            <button
              class="accordion-toggle flex w-full items-center justify-between text-left text-base focus:outline-none cursor-pointer"
              onclick="toggleAccordion(this)"
            >
              <span>Ingrédients</span>
              <img
                src="{{ 'Dropdown arrow.svg' | asset_url }}"
                alt=""
                class="accordion-arrow h-4 w-4 transform transition-transform duration-200"
                aria-hidden="true"
                width="16"
                height="16"
              >
            </button>
            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
              <div class="pt-4">
                <div class="font-normal text-dark text-sm">
                  {{
                    section.settings.ingredients_content
                    | default: 'La liste des ingrédients sera bientôt disponible.'
                  }}
                </div>
              </div>
            </div>
          </div>

          <!-- Utilisation & Précautions -->
          <div class="accordion-item border-b border-gray-200 py-5">
            <button
              class="accordion-toggle flex w-full items-center justify-between text-left text-base focus:outline-none cursor-pointer"
              onclick="toggleAccordion(this)"
            >
              <span>Utilisation & Précautions</span>
              <img
                src="{{ 'Dropdown arrow.svg' | asset_url }}"
                alt=""
                class="accordion-arrow h-4 w-4 transform transition-transform duration-200"
                aria-hidden="true"
                width="16"
                height="16"
              >
            </button>
            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
              <div class="pt-4">
                <div class="font-normal text-dark text-sm">
                  {{
                    section.settings.usage_content
                    | default: "Les instructions d'utilisation seront bientôt disponibles."
                  }}
                </div>
              </div>
            </div>
          </div>

          <!-- Certificats & Études -->
          <div class="accordion-item border-b border-gray-200 py-5">
            <button
              class="accordion-toggle flex w-full items-center justify-between text-left text-base focus:outline-none cursor-pointer"
              onclick="toggleAccordion(this)"
            >
              <span>Certificats & Études</span>
              <img
                src="{{ 'Dropdown arrow.svg' | asset_url }}"
                alt=""
                class="accordion-arrow h-4 w-4 transform transition-transform duration-200"
                aria-hidden="true"
                width="16"
                height="16"
              >
            </button>
            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
              <div class="pt-4">
                <div class="font-normal text-dark text-sm">
                  {{
                    section.settings.certificates_content
                    | default: 'Les certificats et études seront bientôt disponibles.'
                  }}
                </div>
              </div>
            </div>
          </div>

          <!-- Livraison & Retour -->
          <div class="accordion-item border-b border-gray-200 py-5">
            <button
              class="accordion-toggle flex w-full items-center justify-between text-left text-base focus:outline-none cursor-pointer"
              onclick="toggleAccordion(this)"
            >
              <span>Livraison & Retour</span>
              <img
                src="{{ 'Dropdown arrow.svg' | asset_url }}"
                alt=""
                class="accordion-arrow h-4 w-4 transform transition-transform duration-200"
                aria-hidden="true"
                width="16"
                height="16"
              >
            </button>
            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
              <div class="pt-4">
                <div class="font-normal text-dark text-sm">
                  {{
                    section.settings.shipping_content
                    | default: 'Les informations de livraison et retour seront bientôt disponibles.'
                  }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Accordion functionality
    function toggleAccordion(button) {
      const content = button.nextElementSibling;
      const arrow = button.querySelector('.accordion-arrow');

      if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        content.style.maxHeight = '0px';
        arrow.style.transform = 'rotate(0deg)';
      } else {
        content.style.maxHeight = content.scrollHeight + 'px';
        arrow.style.transform = 'rotate(180deg)';
      }
    }

    // Slider functionality
    let currentSlide = 0;
    const slider = document.getElementById('slider');
    const progressIndicator = document.querySelector('.slider-progress-indicator');
    const totalSlides = slider ? slider.children.length : 0;

    function updateSlider() {
      if (!slider || !progressIndicator || totalSlides === 0) return;

      const translateX = -currentSlide * 100;
      slider.style.transform = `translateX(${translateX}vw)`;

      const indicatorPosition = currentSlide * 20; // 20% par slide
      const indicatorWidth = 20; // Fixe à 20% (100/5 slides)
      progressIndicator.style.left = `${indicatorPosition}%`;
      progressIndicator.style.width = `${indicatorWidth}%`;
    }

    function clickProgressBar(event) {
      const progressBar = event.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const barWidth = rect.width;
      const clickPercentage = clickX / barWidth;

      const targetSlide = Math.floor(clickPercentage * totalSlides);
      currentSlide = Math.max(0, Math.min(targetSlide, totalSlides - 1));

      updateSlider();
    }

    // Variant selector functionality
    function changeVariant(variantId) {
      // Update URL with variant parameter
      const url = new URL(window.location);
      url.searchParams.set('variant', variantId);
      window.history.pushState({}, '', url);

      // Update cart price from data attribute
      const selectedOption = document.querySelector(`[data-variant-id="${variantId}"]`);
      if (selectedOption) {
        const price = selectedOption.getAttribute('data-variant-price');

        // Update main price (next to title)
        const mainPriceElement = document.getElementById('main-price');
        if (mainPriceElement && price) {
          mainPriceElement.textContent = price;
        }

        // Update cart price
        const cartPriceElement = document.getElementById('cart-price');
        if (cartPriceElement && price) {
          cartPriceElement.textContent = price;
        }

        // Update form variant ID
        const variantInput = document.getElementById('product-variant-id');
        if (variantInput) {
          variantInput.value = variantId;
        }

        // Update visual selection
        document.querySelectorAll('[data-variant-id]').forEach((option) => {
          const isSelected = option.getAttribute('data-variant-id') === variantId.toString();

          // Update card styling
          if (isSelected) {
            option.className = option.className.replace(
              'border border-gray-light cursor-pointer hover:bg-gray-50',
              'bg-teal-light'
            );
          } else {
            option.className = option.className.replace(
              'bg-teal-light',
              'border border-gray-light cursor-pointer hover:bg-gray-50'
            );
          }

          // Update badge styling
          const badge = option.querySelector('span:first-child');
          if (badge) {
            if (isSelected) {
              badge.className = badge.className.replace('bg-gray-light', 'bg-sage-medium');
            } else {
              badge.className = badge.className.replace('bg-sage-medium', 'bg-gray-light');
            }
          }
        });
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', updateSlider);
  </script>
</main>
<span class="font-gotham font-bold w-full text-center my-10 block"
  >----------------Fin de la section main-product----------------</span
>

{% schema %}
{
  "name": "Product",
  "settings": [
    {
      "type": "header",
      "content": "Contenu des accordéons"
    },
    {
      "type": "richtext",
      "id": "benefits_content",
      "label": "Bienfaits et efficacité",
      "default": "<p>Décrivez ici les bienfaits et l'efficacité de votre produit.</p>",
      "info": "Contenu affiché dans l'accordéon 'Bienfaits et efficacité'"
    },
    {
      "type": "richtext",
      "id": "ingredients_content",
      "label": "Ingrédients",
      "default": "<p>Listez ici les ingrédients de votre produit.</p>",
      "info": "Contenu affiché dans l'accordéon 'Ingrédients'"
    },
    {
      "type": "richtext",
      "id": "usage_content",
      "label": "Utilisation & Précautions",
      "default": "<p>Expliquez ici comment utiliser votre produit et les précautions à prendre.</p>",
      "info": "Contenu affiché dans l'accordéon 'Utilisation & Précautions'"
    },
    {
      "type": "richtext",
      "id": "certificates_content",
      "label": "Certificats & Études",
      "default": "<p>Présentez ici vos certificats et études scientifiques.</p>",
      "info": "Contenu affiché dans l'accordéon 'Certificats & Études'"
    },
    {
      "type": "richtext",
      "id": "shipping_content",
      "label": "Livraison & Retour",
      "default": "<p>Informations sur la livraison et les conditions de retour.</p>",
      "info": "Contenu affiché dans l'accordéon 'Livraison & Retour'"
    },
    {
      "type": "header",
      "content": "Configuration produit"
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Texte du badge",
      "default": "Hautement dosé",
      "info": "Texte affiché sur le badge du produit"
    }
  ],
  "presets": [
    {
      "name": "Product"
    }
  ]
}
{% endschema %}
